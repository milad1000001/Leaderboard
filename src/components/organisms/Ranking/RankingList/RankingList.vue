<template>
    <div
        class="defualtClass rounded-base"
        :class="[{look,'listWrapperTv':isApplicationUser,'listWrapper overflow-y-scroll':!isApplicationUser}]"
    >
        <app-ranking-item
            v-for="(item,index) in list"
            class="rankingListItem"
            :key="index"
            :item="item"
            :mode="'ranklist'"
            :look="look"
            @click.native="callNextApi()"
        />
    </div>
</template>

<script>
import { mapState, mapGetters } from 'vuex';
import RankingItem from '~molecules/Ranking/RankingItem/index.vue';

export default {
  name: 'RankingList',
  components: {
    'app-ranking-item': RankingItem,
  },
  data() {
    return {
      rankingArrayLength: 0,
      rankingArrayIterator: -1,
      scrollInterval: '',
      scrollTimeout: '',
      scrollConfiguration: {
        cursorPosition: {
          currentPosition: '',
          topInterval: 0,
        },
        pageScale: {

        },
        timing: {

        },
        isValid: {
          isEligibleUserForAutomateScroll: this.isEligibleUserForAutomateScroll,
          isPageScrollable: this.isPageScrollable,
          isTimingValidate: this.isTimingValidate,
        },
      },
    };
  },
  props: {
    list: {
      type: Array,
      required: false,
    },
    look: {
      type: String,
      required: true,
    },
  },
  computed: {
    ...mapGetters(
      { loadingState: 'ranking/getLoadingState' },
    ),
    ...mapState('ranking', ['rankingList', 'rankingGroup', 'isOverall']),
    ...mapState('global', ['viewMode']),

    isApplicationUser() {
      if (localStorage.getItem('isApplicationUser') === 'True') {
        return true;
      }
      return false;
    },
    isEligibleUserForAutomateScroll() {
      return this.isApplicationUser;
    },
    isPageScrollable() {
      return 0;
    },
    isTimingValidate() {
      return 0;
    },
    isScrollReachBottomOfPage() {
      return !!(window.innerHeight + window.scrollY > document.body.offsetHeight + 60 && window.scrollY > 100);
    },
  },
  methods: {
    scroll() {
      if (this.loadingState) return;
      if ((window.innerHeight + window.scrollY) >= document.body.offsetHeight) {
        this.stopScroll(100000);
        this.callNextApi();
      } else {
        // window.scroll({
        //   left: 0,
        //   top: this.scrollConfiguration.cursorPosition.topInterval,
        // });
        // this.scrollConfiguration.cursorPosition.topInterval += 1;
      }
    },
    scrollingInterval(scroll, interval) {
      this.scrollInterval = setInterval(() => {
        scroll();
      }, interval);
    },
    stopScroll(timeOutTime) {
      clearInterval(this.scrollInterval);
      clearTimeout(this.scrollTimeout);
      this.startScrollTimer(timeOutTime);
    },
    startScroll() {
      this.scrollingInterval(this.scroll, 1);
    },
    startScrollTimer(timeOutTime) {
      this.scrollTimeout = setTimeout(this.scrollHandler, timeOutTime);
    },
    scrollHandler() {
      this.startScroll();
    },
    async callNextApi(forceRankingIterator) {
      window.scrollTo(0, 0);
      this.scrollConfiguration.cursorPosition.topInterval = 0;
      if (this.rankingArrayIterator < this.rankingGroup.length) {
        this.rankingArrayIterator = forceRankingIterator || this.rankingArrayIterator + 1;
        console.log(
          'Theme:', this.$route.params.theme,
          'RankingArrayIterator:', this.rankingArrayIterator,
          'Length:', this.rankingGroup.length, 'ID:', this.rankingGroup[this.rankingArrayIterator].id,
        );
        await this.$store.dispatch('ranking/getRankingList', [this.rankingGroup[this.rankingArrayIterator].id, this.$route.params.theme]);
        if (!this.rankingList.header.hasData) {
          console.log('Got no data. Caliing next API with ', this.rankingArrayIterator + 1);
          window.scrollTo(0, 0);
          this.scrollConfiguration.cursorPosition.topInterval = 0;
          await this.callNextApi(this.rankingIterator + 1);
          return;
        }
        this.scrollHandler();
      } else {
        this.rankingArrayIterator = -1;
      }
    },
  },
  mounted() {
    this.$store.dispatch('ranking/getRankingGroups', this.$route.params.theme).then(() => {
      this.scrollHandler();
      window.scrollTo(0, 0);
      ['wheel', 'click'].forEach((eventType) => {
        document.addEventListener(eventType, () => {
          this.stopScroll(10000);
          this.scrollConfiguration.cursorPosition.topInterval = window.scrollY;
        });
      });
    });
  },
};
</script>

<style lang="scss" scoped>
@media only screen and (max-width: 958px){
.listWrapper{
    max-height:max-content !important;
  }
}
.listWrapperTV{
  max-height:max-content !important;
}
.listWrapper{
  scroll-behavior: smooth;
  max-height: calc(7*64px);
  &::-webkit-scrollbar {
        width: 3px;
        height: 5px;
    }

    &::-webkit-scrollbar-track {
        border-radius: 5px;
        margin: 20px 0;
    }

    &::-webkit-scrollbar-thumb {
        background: theme('colors.blue.400');
        border-radius: 10px;
    }

    &::-webkit-scrollbar-thumb:hover {
        background: theme('colors.blue.200');
    }
}
.defualtClass{
    background-color: theme('colors.blue.600');
}
.rankingListItem{
  scroll-behavior: smooth;
  &:nth-child(even){
    background-color: theme('colors.gray.800');
  }
}
</style>
